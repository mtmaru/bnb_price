# ProbSpace 民泊コンペ 2nd Place Solution

ProbSpace[「民泊サービスの宿泊料金予測」](https://comp.probspace.com/competitions/bnb_price)の 2nd place solution です。

## 解法

ここでは解法を簡単に説明します。<br>
この解法に至った背景や意図は[「この解法に至るまでの過程」](#この解法に至るまでの過程)を参照してください。

### 特徴抽出

- 施設名称 `name` のtf-idf (スペース区切り)
    - 前処理として、数値を0に置換。
    - スペース区切りで単語に分割し、その単語でtf-idfを計算。
    - tf-idfを計算した後、SVDで次元削減。
- 施設名称 `name` のtf-idf (文字N-gram)
    - 前処理として、数値を0に置換＆スペースを除去。
    - 文字ベースのN-gramを作り、そのN-gramでtf-idfを計算。
    - tf-idfを計算した後、SVDで次元削減。
- 施設名称に含まれている施設のスペック
    - 宿泊可能人数
    - ベッド数
    - 広さ
    - 駅までの時間
- 駅の近さ
    - $\exp(-\gamma ||施設 - 駅||)$
        - 施設の近くにある駅は1に、遠くにある駅は0に近い値を取る。
    - 全駅への近さを計算した後、PCAで次元削減。
- 所在地 `neighbourhood`
- 緯度 `latitude`
- 経度 `longitude`
- 部屋の形式 `room_type`
- 最短宿泊日数 `minimum_nights`
- 評価件数 `number_of_reviews`
- 月当たりの評価件数 `reviews_per_month`
- 年間の宿泊可能日数 `availability_365`

### モデル

- 100個のLightGBMのバギング。
- ハイパーパラメーターはOptunaで最適化した。

### 後処理

- 極端に高額と思われる施設の補正
    - "Uhome ..." から始まる施設の価格を90万円に置き換えた。
    - "Uhome ..." だけでなく、同じホストが運営する他施設も同様に置き換えた。
- 1泊料金を設定すべきところを誤って月額料金を設定していると思われる施設の補正
    - "★Monthly Rental ..." から始まる施設のうち、一軒家の価格を20万円に、一軒家以外の価格を10万円に置き換えた。
    - "★Monthly Rental ..." だけでなく、同じホストが運営する他施設も同様に置き換えた。
- 極端に低額と思われる施設の補正1
    - シェアルームタイプ施設の価格を、訓練データの同施設の価格の中央値に置き換えた。
- 極端に低額と思われる施設の補正2
    - 施設名称に "Simple" が含まれる施設の価格を、訓練データの同施設の価格の中央値に置き換えた。

### 評価

- 5分割交差検証 (グループ化なし)

## コード

- 1_train-opt.ipynb
    - Optunaでハイパーパラメーターを最適化するコード。
- 2_train-bagging.ipynb
    - 最適化したハイパーパラメーターを使って学習とテストデータに対する予測を行うコード。
- 3_postprocess.ipynb
    - 予測結果を補正するコード。

## この解法に至るまでの過程

### チームの方針決め

スキルアップを目的に、会社の同僚とチームを組んで参加しました。

- チームメンバー
    - [genta0608](https://comp.probspace.com/users/genta0608/0)
    - [ko](https://comp.probspace.com/users/ko/0)
    - [maruyama](https://comp.probspace.com/users/maruyama/0) *最終提出物の作成
    - [yo-zef2](https://comp.probspace.com/users/yo-zef2/0) *リーダー
- コンペに参加する目的
    - 業務では機会のない分野のデータ分析を経験することで、各メンバーのデータ分析スキルを向上させる。
- 役割分担
    - 目的を果たすには各メンバーが分析全体を経験することが重要なので、分担はせず各自で自由に作業する。
    - 進捗を随時報告し、お互いにレビューしあう。
- コミュニケーションルール
    - 随時Slackで進捗を報告する。
    - 後から振り返れるようにしておきたいので、報告内容は社内wikiにも記載する。
    - 相談事項が発生したらミーティングを設定し、みんなで話し合う。

### ドメイン知識の獲得

分析を始めるにあたり、題材になっているAirbnbに関する調査を行いました。

#### データの制約や注意事項

※参照元：[Inside Airbnb: Data Assumptions](http://insideairbnb.com/data-assumptions)

- `neighbourhood`
    - ホストの申請情報は使わず、緯度経度から割り出している。申請情報はウソかもしれないから。
- `latitude`, `longitude`
    - 匿名化のため緯度経度に0～450フィートのノイズが加えられている。
    - 緯度経度のノイズは物件ごとに加えられる。例えば、ホテルのような同じ場所に物件が複数ある場合、真の緯度経度を中心にばらついているように見える。
- `number_of_reviews`, `last_review`, `reviews_per_month`
    - レビューにはスパムが含まれている可能性がある。ただ、そんなに多くないから気にしなくていい。
- `availability_365`
    - 宿泊可能に設定されている日をカレンダーからカウントしている。
    - 宿泊できない理由は区別できない。本当は、ホストがブロックしている場合と、予約いっぱいの場合がある。
    - ホストがカレンダーの更新をさぼっている可能性がある。

#### Airbnbの価格の決め方

※参照元：[料金設定 - Airbnbヘルプセンター](https://www.airbnb.jp/help/topic/1486/料金設定)

- どの料金を予測すればいいのか？
    - 料金の内訳
        - 最終的に顧客へ請求する料金 = 1予約あたりの料金 * 割引 * Airbnbサービス料 * 消費税
        - 1予約あたりの料金 = 1泊あたりの料金 * 宿泊日数 + 1予約あたりの諸費用 + 手数料
        - 1泊あたりの料金 = 1泊あたりの基本料金 + 追加ゲスト料金 * 追加ゲスト人数 + 1泊あたりの諸費用
    - 予測対象の料金
        - Airbnbのデフォルト表示は「1泊あたりの基本料金」のため、おそらく「1泊あたりの基本料金」を予測すればよいはず。
- 料金の種類による影響はあるか？
    - 料金の種類
        - 基本料金
        - 週末料金
        - カスタム料金 (特定の日だけに設定された特別料金)
    - 料金の種類による予測への影響
        - 本コンペのデータはある時点のスナップショットだから、全施設が基本料金/週末料金のいずれかに統一されているとみなせる。
        - カスタム料金の影響は残りそう。
        - カスタム料金は該当地域の需要が一時的に高まる際に設定するものだから、地域を説明変数に入れれば影響を緩和できそう。
        - 各施設の料金の種類はデータに含まれていない。
- 料金の調整方法による影響はあるか？
    - 料金の調整方法
        - ホスト自身による手動調整
        - Airbnbのスマートプライシングによる自動調整
    - 料金の調整方法による予測絵の影響
        - 手動調整の場合、適正価格から乖離した価格設定のまま放置されている可能性がありそう。
        - 手動調整の質はホストに依存するから、同じホストか否かを表す説明変数を入れれば影響を緩和できそう。
        - 各施設の料金の調整方法はデータに含まれていない。

### データ観察と仮説立案

#### 価格 (`y`)

- 100万円近い高額な施設 ("Uhome ...") があるものの、データを見る限りだと100万円の価値がある施設には見えない。
    - 相場並みに予測してしまい予測値が大きく下振れする可能性が高いため、予測精度への影響が大きそう。
    - 予測は困難なため、訓練データで高額だった施設の予測結果を後処理で補正したほうがよさそう。
- 1泊料金を設定すべきところを誤って月額料金を設定していると思われる施設 ("★Monthly Rental ...") がある。ただし、正しく1泊料金を設定している施設もあるため、施設名称に含まれるキーワード ("monthly" など) から1泊料金か月額料金か判別することは難しい。
    - 1泊料金のつもりで予測してしまい予測値が大きく下振れする可能性が高いため、予測精度への影響が大きそう。
    - 予測は困難なため、訓練データで月額料金設定だった施設の予測結果を後処理で補正したほうがよさそう。
- 1泊数千円で泊まれる極端に安い施設がある。シェアハウスやホステルと思われるが、データからは判断できそうにない。
    - 評価指標がRMSLEのため、極端に安い施設 (2千円など) を相場並み (6千円など) と予測してしまうだけで予測精度へ大きな影響が出うる。
    - 予測は困難なため、訓練データで激安だった施設の予測結果を後処理で補正したほうがよさそう。

#### 施設名称 (`name`)

- 似た価格の施設を複数運営している (同じマンションの101号室、102号室、……など) ホストが多い。
    - 同じホストの施設の価格は当てやすいはず。
    - 同じホストか否かは施設名称に含まれる単語で判別できそうなので、施設名称のtf-idfが効きそう。
    - 部屋番号違いの施設が多いため、tf-idfを計算する前に部屋番号を取り除いたほうがよさそう。
- 複数の言語で書かれている。
    - ターゲットの国籍に合わせて価格を変えているかもしれないので、言語 (≒国籍) を説明変数に入れると効きそう。
    - スペース区切りではない言語向けに、文字N-gramによるtf-idfも説明変数に入れたほうがよさそう。
- 施設名称に施設のスペック (人数、ベッド数、広さ、駅までの時間、Wi-Fiの有無、……など) が書かれている。
    - 人数や広さは価格に直結しそうなので、抽出して説明変数に入れると効きそう。
    - 抽出する代わりに、N-gramを取ってtf-idfを計算したり、BERTをファインチューニングしたりしてもいいかもしれない。
- 文字数を減らすためにスペースを省いていることがある (MAX4、……など)。
    - スペース区切りで単語に分けてtf-idfを計算するとうまく行かないので、文字N-gramによるtf-idfも説明変数に入れたほうがよさそう。
- Airbnb独特のスラング (ppl、BR、……など) や略語 (mins、sta、……など) が含まれている。
    - 学習済みモデルで分散表現を得る前処理として、スラングや略語を標準的な単語に置き換えたほうがよさそう。

#### 位置情報 (`neighbourhood`、`latitude`、`longitude`)

- 緯度経度だけより、所在地や最寄り駅も説明変数に入れたほうが予測精度が高い。重要度も緯度経度より所在地や最寄り駅のほうが高い。
    - おそらく地域ごとに相場が決まっているため、地域を表す変数 (所在地や最寄り駅など) を説明変数に入れたほうがよさそう。
- ほぼ同じ場所に異なる駅が複数ある (秋葉原と岩本町、など)。
    - 主要駅に絞った上で最寄り駅を求めたほうがよさそう。

#### 評価 (`last_review`、`reviews_per_month`)

- 評価が欠けている施設の価格が高い。
    - 価格が高いと予約が入らないから評価が欠けるのかもしれない。評価の欠損を説明変数に入れると効きそう。

#### 訓練データとテストデータのホストの重複

- 訓練データとテストデータに `host_id` の重複がない。
    - テストデータに訓練データと同じホストの施設がないということだから、異なるホストの施設に対する予測精度を評価しないとリーダーボードに近い予測精度は得られないはず。
    - `host_id` でグループ化して交差検証するのがよさそう。
- 施設名称を見ると、訓練データとテストデータに同じホストが運営していると思われる施設が少なからずある。
    - `host_id` の重複がないだけで、実質的にはテストデータにも訓練データと同じホストの施設が含まれている……？
    - もしそうなら、同じホストの施設の価格を正確に当てられることも重要なので、グループ化せずに交差検証するのがよさそう。

### ベースラインモデルの作成

ドメイン知識の獲得とデータ観察で得た仮説をもとに、ベースラインモデルを作成しました。

#### 特徴抽出

- 同じホストか否かを判別するための特徴量
    - 施設名称 `name` のtf-idf (スペース区切り)
        - 大半を占める英語の施設名称から特徴量を得るため。
        - 部屋番号違いなどを無視するため、前処理として数値を0に置換。
    - 施設名称 `name` のtf-idf (文字N-gram)
        - 日本語や中国語で書かれた施設名称やスペースが省かれた英語の施設名称から特徴量を得るため。
        - 部屋番号違いなどを無視するため、前処理として数値を0に置換。
        - N-gramのNは1～4の4パターン。5以上を試さなかったのは単にメモリが足りなかったから。
- 地域ごとの相場やカスタム料金の影響を反映するための特徴量
    - 駅の近さ $\exp(-\gamma ||施設 - 駅||)$
        - 最寄り駅の代わり。
        - 全駅の近さを求め主成分分析にかけることで、ほぼ同じ位置にある駅が一つの主成分へ統合されることを期待。
    - 所在地 `neighbourhood`
    - 緯度 `latitude`
    - 経度 `longitude`
- その他
    - 部屋の形式 `room_type`
    - 最短宿泊日数 `minimum_nights`
    - 評価件数 `number_of_reviews`
    - 月当たりの評価件数 `reviews_per_month`
        - 欠損は補完せず、そのままLightGBMへ与えた。
    - 年間の宿泊可能日数 `availability_365`

#### モデル

- LightGBM
- ハイパーパラメーターはOptunaで最適化した。

#### 評価

- 訓練データとテストデータの両方に含まれているホストが運営する施設の価格を正確に予測することを目指したかったので、あえて `host_id` でグループ化しない交差検証で予測精度を評価することにした。
- CV0.5強に対しPL0.8前後でかなり乖離していたものの、CVが下がるとPLも連動して下がる傾向にはあった。

### モデルの改善

#### 施設スペックの追加

- tf-idfを計算する際に数値を0に置換していたため、数値の情報が欠落していた。
- 欠落した情報を補うため、宿泊可能人数・ベッド数・広さ・駅までの時間を施設名称から抽出し、説明変数に加えた。

#### バギングの追加

- Optunaが `lambda_l1` を大きく設定したり `feature_fraction` を小さく設定したりすることが多かったことから本コンペは過学習しやすいと判断し、LightGBMのモデルをバギングすることにした。

### 予測結果の補正

データ観察の結果から一部施設は正しく予測できず大幅に外すことが予想されたので、該当施設の予測結果をルールベースで補正しました。

- 極端に高額と思われる施設の補正
    - "Uhome ..." から始まる施設の価格を90万円に置き換えた。
    - "Uhome ..." だけでなく、同じホストが運営する他施設も同様に置き換えた。
    - 置き換える価格 (90万円) は、訓練データに含まれる同施設の価格を参考に、切りのいい数字を選んで決めた。
- 1泊料金を設定すべきところを誤って月額料金を設定していると思われる施設の補正
    - "★Monthly Rental ..." から始まる施設のうち、一軒家の価格を20万円に、一軒家以外の価格を10万円に置き換えた。
    - "★Monthly Rental ..." だけでなく、同じホストが運営する他施設も同様に置き換えた。
    - 置き換える価格 (20万円/10万円) は、訓練データに含まれる同施設の価格を参考に、切りのいい数字を選んで決めた。
- 極端に低額と思われる施設の補正1
    - シェアルームタイプ施設の価格を、訓練データの同施設の価格の中央値に置き換えた。
    - シェアルームタイプ施設を選んだのは、ホステル (＝低価格の施設) は形式がシェアルームのはずだから。
    - 部屋の形式 `room_type` を説明変数に入れているため補正する必要はなさそうだが、価格の分布を確認したところ予測結果が訓練データよりも上振れしていたことから補正が必要だと判断した。
- 極端に低額と思われる施設の補正2
    - 施設名称に "Simple" が含まれる施設の価格を、訓練データの同施設の価格の中央値に置き換えた。
    - キーワードとして "Simple" を選んだのは、低価格の施設によく含まれている単語だったから。
    - 施設名称のtf-idfを説明変数に入れているため補正する必要はなさそうだが、価格の分布を確認したところ予測結果が訓練データよりも上振れしていたことから補正が必要だと判断した。

### 予測精度の推移

| 提出内容 | Public LB | Private LB |
|:--|--:|--:|
| ベースライン | 0.79247 | 0.73368 |
| 高額施設と月極施設を補正 | 0.75964 | 0.71092 |
| 低額施設を補正1 (シェアルームタイプ施設) | 0.74348 | 0.70463 |
| 施設スペックを追加 + バギング | 0.73239 | 0.69484 |
| 低額施設を補正2 ("Simple" を含む施設) | 0.73262 | 0.69139 |
